<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Venta semana sierras</title>
    <link id="app-favicon" rel="icon" type="image/png" href="">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { background: #f0f2f5; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        .login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: #2c3e50; }
        .sidebar { 
            height: 100vh; 
            position: fixed; 
            top: 0; 
            left: 0; 
            background: #212529; 
            color: white; 
            z-index: 3000; 
            width: 250px; 
            overflow-x: hidden; 
            overflow-y: auto; /* <--- ESTO ES LO NUEVO: Permite bajar si el men√∫ es muy largo */
            white-space: nowrap; 
            transition: width 0.2s ease-in-out; 
        }
        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed .nav-text, .sidebar.collapsed .sidebar-header-text { display: none; }
        .sidebar.collapsed .nav-link { justify-content: center; padding-left: 0; padding-right: 0; }
        .sidebar.collapsed .bi { margin-right: 0 !important; font-size: 1.5rem; }
        .main-content { padding: 20px; min-height: 100vh; margin-left: 250px; transition: margin-left 0.2s ease-in-out; }
        .main-content.expanded { margin-left: 80px; }
        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-100%); width: 250px; transition: transform 0.3s; }
            .sidebar.active { transform: translateX(0); }
            .sidebar.collapsed { width: 250px; } 
            .main-content { margin-left: 0 !important; padding-top: 60px; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1040; }
            .overlay.active { display: block; }
            .mobile-header { display: flex; }
            .toggle-desktop-btn { display: none; }
        }
        @media (min-width: 992px) { .mobile-header { display: none; } }
        .mobile-header { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background: #212529; color: white; z-index: 1030; align-items: center; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav-link { color: rgba(255,255,255,.75); cursor: pointer; padding: 12px 20px; display: flex; align-items: center; }
        .nav-link i { margin-right: 10px; font-size: 1.2rem; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,.1); border-left: 4px solid #0d6efd; }
        .card-prod { cursor: pointer; transition: 0.2s; border: none; }
        .card-prod:active { transform: scale(0.95); }
        .disabled-prod { opacity: 0.6; filter: grayscale(1); pointer-events: none; cursor: not-allowed; }
        .category-tag { font-size: 0.8rem; font-weight: bold; color: white !important; margin-bottom: 3px; display: inline-block; margin-right: 4px; padding: 3px 8px; border-radius: 4px; }
        .custom-dropdown { position: relative; }
        .dropdown-list { position: absolute; top: 100%; left: 0; width: 100%; max-height: 250px; overflow-y: auto; background: white; border: 1px solid #ced4da; z-index: 100; border-radius: 0 0 5px 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .dropdown-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        .dropdown-item:hover { background: #f8f9fa; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; padding: 5px; border: 1px solid #ced4da; border-radius: 0.375rem; background: white; min-height: 38px; }
        .tag-badge { background-color: #0d6efd; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; display: flex; align-items: center; }
        .tag-remove { margin-left: 5px; cursor: pointer; opacity: 0.7; }
        .tag-input { border: none; outline: none; flex-grow: 1; min-width: 100px; padding: 2px 5px; }
        .suggestions-list { position: absolute; background: white; border: 1px solid #ddd; width: 100%; max-height: 150px; overflow-y: auto; z-index: 1000; list-style: none; padding: 0; margin-top: 2px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 8px 12px; cursor: pointer; }
        .suggestion-item:hover { background-color: #f8f9fa; color: #0d6efd; }
        .reembolsado { text-decoration: line-through; opacity: 0.6; background-color: #ffebee !important; }
        .filter-label { font-size: 0.75rem; color: #6c757d; margin-bottom: 2px; display: block; }
    </style>
</head>
<body x-data="appData()" x-init="initApp()">

    <div x-show="!token" class="login-screen">
        <div class="card p-4 shadow-lg border-0" style="width: 350px;">
            <div class="text-center mb-4"><h1>üèîÔ∏è</h1><h3>Sierras de Bellavista</h3></div>
            <div class="mb-3"><input type="text" class="form-control" x-model="loginForm.username" placeholder="Usuario"></div>
            <div class="mb-4"><input type="password" class="form-control" x-model="loginForm.password" @keyup.enter="login()" placeholder="Contrase√±a"></div>
            <button class="btn btn-primary w-100" @click="login()" :disabled="cargando">Ingresar</button>
            <p x-show="loginError" class="text-danger text-center mt-3 small">Credenciales incorrectas</p>
        </div>
    </div>

    <div x-show="token" style="display: none;">
        <div class="overlay" :class="{ 'active': mobileMenuOpen }" @click="mobileMenuOpen = false"></div>
        <div class="mobile-header d-lg-none"><button class="btn text-white fs-4 me-3" @click="mobileMenuOpen = !mobileMenuOpen"><i class="bi bi-list"></i></button><h5 class="m-0 fw-bold">üèîÔ∏è Sierras de Bellavista</h5></div>

        <div class="sidebar d-flex flex-column" :class="{ 'collapsed': sidebarCollapsed, 'active': mobileMenuOpen }">
            
            <div class="p-3 d-flex align-items-center justify-content-between border-bottom border-secondary" style="height: 70px;">
                <div class="sidebar-header-text overflow-hidden d-flex align-items-center">
                    <img x-show="config.app_logo" :src="config.app_logo" style="height:30px; margin-right:10px;">
                    <div><h5 class="m-0 fw-bold">üèîÔ∏è Sierras de Bellavista</h5><small class="text-white-50" x-text="currentUser.nombre"></small></div>
                </div>
                <button class="btn btn-sm text-white toggle-desktop-btn" @click="sidebarCollapsed = !sidebarCollapsed"><i class="bi" :class="sidebarCollapsed ? 'bi-list' : 'bi-chevron-left'"></i></button>
            </div>

            <div x-show="!online" class="bg-danger text-white text-center fw-bold p-2 small border-bottom border-danger-subtle" x-transition>
                <i class="bi bi-wifi-off"></i> SIN CONEXI√ìN
            </div>

            <div x-show="ventasPendientes.length > 0" class="m-2 p-2 bg-warning text-dark rounded small" x-transition>
                <div class="d-flex align-items-center justify-content-between mb-1">
                    <strong class="d-flex align-items-center gap-1"><i class="bi bi-cloud-slash-fill"></i> <span x-text="ventasPendientes.length"></span> pendientes</strong>
                </div>
                <div style="font-size: 0.75rem; line-height: 1.2;" class="mb-2">
                    Se guardaron en el tel√©fono porque no hab√≠a se√±al.
                </div>
                <button @click="intentarSincronizar()" class="btn btn-sm btn-dark w-100 py-0" :disabled="!online || sincronizando">
                    <span x-show="sincronizando" class="spinner-border spinner-border-sm me-1"></span>
                    <span x-text="sincronizando ? 'Subiendo...' : (online ? 'üîÑ Subir Ahora' : 'üö´ Esperando se√±al')"></span>
                </button>
            </div>
            
            <ul class="nav flex-column mt-2">
                <template x-for="menuId in menuOrder" :key="menuId">
                    <li class="nav-item" :title="menuItems[menuId].label" x-show="!menuItems[menuId].adminOnly || currentUser.role === 'admin'">
                        <a class="nav-link" :class="{ 'active': view === menuId }" @click="navigate(menuId)">
                            <i class="bi" :class="menuItems[menuId].icon"></i> 
                            <span class="nav-text" x-text="menuItems[menuId].label"></span>
                        </a>
                    </li>
                </template>
            </ul>

            <div class="mt-auto p-3 border-top border-secondary pb-5 mb-5">
                <button class="btn btn-outline-light w-100 btn-sm" @click="logout()">
                    <i class="bi bi-box-arrow-left"></i> <span class="nav-text">Salir</span>
                </button>
            </div>
        </div>

        <div class="main-content" :class="{ 'expanded': sidebarCollapsed }">
            
            <div x-show="view === 'pos'">
                <div class="fixed-bottom bg-dark text-white p-3 d-lg-none shadow-lg d-flex justify-content-between align-items-center" 
                    x-show="carrito.length > 0 && !mobileCartOpen" 
                    style="z-index: 1060; cursor: pointer; border-top: 1px solid #444;"
                    @click="mobileCartOpen = true"
                    x-transition.opacity.duration.300ms>
                    
                    <div class="d-flex align-items-center">
                        <div class="bg-primary rounded-circle d-flex justify-content-center align-items-center me-2" style="width: 40px; height: 40px;">
                            <span class="fw-bold" x-text="carrito.reduce((a,b)=>a+b.cantidad,0)"></span>
                        </div>
                        <div class="lh-1">
                            <small class="text-white-50" style="font-size: 0.8rem;">Total a Pagar</small>
                            <div class="fw-bold fs-5" x-text="'$' + formatMoney(totalCarrito)"></div>
                        </div>
                    </div>
                    <button class="btn btn-outline-light btn-sm fw-bold">Ver Carro <i class="bi bi-chevron-up"></i></button>
                </div>

                <div class="row g-3">
                    <div class="col-12 col-lg-8 order-1 order-lg-1">
                        <div class="d-flex flex-column gap-2 mb-3">

                            <div x-show="!online" style="display: none;" class="alert alert-danger border-0 shadow-sm text-center m-0" x-transition>
                                <div class="fw-bold fs-5"><i class="bi bi-wifi-off"></i> SIN CONEXI√ìN</div>
                                <div class="small opacity-75">Modo Offline. Las ventas se guardar√°n en tu dispositivo.</div>
                            </div>

                            <template x-if="ventasPendientes.length > 0">
                                <div class="alert alert-warning border-0 shadow-sm d-flex justify-content-between align-items-center m-0" x-transition>
                                    <div>
                                        <strong class="d-flex align-items-center gap-2 text-dark">
                                            <i class="bi bi-cloud-slash-fill fs-5"></i> 
                                            <span class="fs-5" x-text="ventasPendientes.length"></span> ventas por subir
                                        </strong>
                                        <div class="small text-muted" style="line-height:1;">Est√°n guardadas en este dispositivo.</div>
                                    </div>
                                    <button @click="intentarSincronizar()" class="btn btn-dark fw-bold px-3 py-2" :disabled="!online || sincronizando">
                                        <span x-show="sincronizando" class="spinner-border spinner-border-sm me-1"></span>
                                        <span x-text="sincronizando ? 'Subiendo...' : (online ? '‚òÅÔ∏è Subir Ahora' : 'üö´ Esperando red')"></span>
                                    </button>
                                </div>
                            </template>

                        </div>
                        <input type="text" class="form-control form-control-lg mb-3 shadow-sm" placeholder="üîç Buscar producto..." x-model="searchProd">
                        
                        <div class="row g-2 pb-5"> 
                            <template x-for="p in productosFiltrados.filter(x => x.activo)" :key="p.id">
                                <div class="col-6 col-md-4 col-lg-3">
                                    <div class="card card-prod h-100 shadow-sm border-0" :class="{'disabled-prod': (p.stock || 0) <= 0}" @click="(p.stock||0) > 0 && agregarAlCarro(p)">
                                        <div class="card-body text-center p-2 d-flex flex-column justify-content-center position-relative">
                                            <span x-show="(p.stock||0) < 5 && (p.stock||0) > 0" class="position-absolute top-0 end-0 badge bg-warning text-dark m-1" style="font-size: 0.6rem;">Poco Stock</span>

                                            <div class="mb-2 bg-light rounded d-flex align-items-center justify-content-center overflow-hidden mx-auto" style="height:100px; width: 100%;">
                                                <span x-show="!p.foto" class="text-muted fs-1">üì¶</span>
                                                <img x-show="p.foto" :src="p.foto" style="width:100%; height:100%; object-fit:contain;" onerror="this.style.display='none'; this.previousElementSibling.style.display='inline'">
                                            </div>
                                            <div class="mb-1" style="min-height: 20px;"><template x-for="cat in (p.categoria || '').split(',').filter(Boolean)"><span class="badge bg-secondary-subtle text-secondary border category-tag" x-text="cat"></span></template></div>
                                            <h6 class="fw-bold m-0 text-dark text-truncate small" x-text="p.nombre"></h6>
                                            <div class="fw-bold mt-1" :class="(p.stock||0) > 0 ? 'text-primary' : 'text-danger'" x-text="(p.stock||0) > 0 ? '$' + formatMoney(p.precio) : 'Agotado'"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="col-12 col-lg-4 order-2 order-lg-2">
            
                        <div x-show="mobileCartOpen" 
                            class="d-lg-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75" 
                            style="z-index: 1090;" 
                            @click="mobileCartOpen = false" 
                            x-transition.opacity>
                        </div>

                        <div class="card shadow border-0 bg-white"
                            :class="{
                                'd-none d-lg-block': !mobileCartOpen, 
                                'position-fixed bottom-0 start-0 w-100 rounded-top-4': mobileCartOpen
                            }"
                            style="max-height: 85vh; display: flex; flex-direction: column;"
                            :style="mobileCartOpen ? 'z-index: 2000; border-radius: 20px 20px 0 0;' : 'position: sticky; top: 20px; z-index: 1000;'"
                        >
                            
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-3" 
                                :class="{'rounded-top-4': mobileCartOpen}">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="fw-bold fs-5"><i class="bi bi-cart3"></i> Carrito</span>
                                    <span class="badge bg-white text-primary rounded-pill" x-text="carrito.length"></span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-light d-lg-none me-2" @click="mobileCartOpen = false"><i class="bi bi-chevron-down"></i></button>
                                    <button class="btn btn-sm btn-light text-primary" @click="vaciarCarro()" title="Limpiar"><i class="bi bi-trash"></i></button>
                                </div>
                            </div>

                            <div class="card-body p-3 overflow-auto" style="background: #f8f9fa;">
                                <div class="mb-3 custom-dropdown bg-white p-2 rounded border" @click.outside="showFamList = false">
                                    <label class="form-label small text-muted mb-1 fw-bold">üë§ Cliente / Familia</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control border-0 shadow-none ps-0" 
                                            :class="ventaActual.familiaId ? 'text-success fw-bold' : ''" 
                                            placeholder="Buscar familia..." 
                                            x-model="searchFamInput" 
                                            @click="showFamList = true; searchFamInput = ''" 
                                            @input="showFamList = true; validarFamilia()">
                                        <span class="input-group-text bg-white border-0" x-show="ventaActual.familiaId"><i class="bi bi-check-circle-fill text-success fs-5"></i></span>
                                    </div>
                                    <div class="dropdown-list shadow-lg rounded mt-1 border-0" x-show="showFamList">
                                        <div class="dropdown-item d-flex align-items-center py-2 text-primary bg-light border-bottom" 
                                            style="cursor: pointer;" 
                                            @click="abrirModalFamiliaPOS()">
                                            <i class="bi bi-plus-circle-fill me-2"></i> 
                                            <strong>Crear nueva familia</strong>
                                        </div>
                                        <template x-for="f in familiasFiltradas" :key="f.id">
                                            <div class="dropdown-item d-flex justify-content-between align-items-center py-2" @click="seleccionarFamilia(f)">
                                                <span x-text="f.nombre" class="fw-bold text-dark"></span>
                                                <span class="badge bg-light text-dark border" x-text="'ID ' + f.id"></span>
                                            </div>
                                        </template>
                                        <div x-show="familiasFiltradas.length === 0" class="p-3 text-center text-muted small">
                                            No se encontraron coincidencias.
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white border rounded p-2 mb-3 shadow-sm" style="max-height: 35vh; overflow-y: auto;">
                                    <template x-for="(item, i) in carrito" :key="i">
                                        <div class="d-flex justify-content-between align-items-center border-bottom py-2 px-1">
                                            <div style="width: 50%; line-height: 1.2;">
                                                <div class="fw-bold text-dark text-truncate small" x-text="item.nombre"></div>
                                                <small class="text-muted" style="font-size: 0.75rem;" x-text="'$' + formatMoney(item.precio) + ' c/u'"></small>
                                            </div>
                                            <div class="d-flex align-items-center gap-1">
                                                <div class="input-group input-group-sm" style="width: 90px;">
                                                    <button class="btn btn-outline-secondary px-2" @click="if(item.cantidad>1) item.cantidad--" type="button">-</button>
                                                    <input type="number" class="form-control text-center px-0" x-model.number="item.cantidad" min="1" readonly>
                                                    <button class="btn btn-outline-secondary px-2" @click="item.cantidad++" type="button">+</button>
                                                </div>
                                                <button class="btn btn-sm text-danger ms-1" @click="carrito.splice(i,1)"><i class="bi bi-x-lg"></i></button>
                                            </div>
                                        </div>
                                    </template>
                                    <div x-show="carrito.length===0" class="text-center text-muted py-5">
                                        <i class="bi bi-cart-x display-1 opacity-25"></i>
                                        <p class="mt-2 small">El carrito est√° vac√≠o</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border shadow-sm">
                                    <div class="d-flex justify-content-between align-items-end mb-3">
                                        <span class="text-muted">Total a Pagar</span>
                                        <span class="display-6 fw-bold text-primary" x-text="'$' + formatMoney(totalCarrito)"></span>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success btn-lg fw-bold shadow-sm d-flex justify-content-between align-items-center px-4" @click="ventaActual.metodo='Efectivo'; procesarVenta()">
                                            <span>üíµ Efectivo</span> <i class="bi bi-chevron-right"></i>
                                        </button>
                                        <button class="btn btn-dark btn-lg fw-bold shadow-sm d-flex justify-content-between align-items-center px-4" @click="ventaActual.metodo='Cuenta'; procesarVenta()">
                                            <span>üìì Cuenta Familiar</span> <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div x-show="view === 'ventas'">
                <h3>Historial de Ventas</h3>
                <div class="card p-3 mb-3 border-0 shadow-sm">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-2"><span class="filter-label">Desde</span><input type="date" class="form-control" x-model="filters.startDate"></div>
                        <div class="col-md-2"><span class="filter-label">Hasta</span><input type="date" class="form-control" x-model="filters.endDate"></div>
                        <div class="col-md-3"><span class="filter-label">Buscar</span><input type="text" class="form-control" placeholder="Familia o Vendedor" x-model="filters.search"></div>
                        <div class="col-md-2"><span class="filter-label">M√©todo</span><select class="form-select" x-model="filters.metodo"><option value="">Todos</option><option value="Efectivo">Efectivo</option><option value="Cuenta">Cuenta</option><option value="reembolsado">Anulado</option></select></div>
                        <div class="col-md-3" x-show="currentUser.role === 'admin'"> <span class="filter-label">Vendedor</span>
                            <select class="form-select" x-model="filters.vendedor">
                                <option value="">Todos</option>
                                <template x-for="v in uniqueVendedores" :key="v">
                                    <option :value="v" x-text="v"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-responsive bg-white rounded shadow-sm">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th> <th>Fecha</th>
                                <th>Vendedor</th>
                                <th>Familia</th>
                                <th>Total</th>
                                <th>Saldo</th>
                                <th>M√©todo</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="v in ventasFiltradas" :key="v.id">
                                <tr :class="{'reembolsado': v.status === 'reembolsado'}">
                                    <td>
                                        <span class="badge bg-secondary" x-text="v.id"></span>
                                    </td>
                                    
                                    <td class="small text-muted" x-text="new Date(v.fecha).toLocaleString()"></td>
                                    <td x-text="v.vendedor"></td>
                                    <td>
                                        <div class="fw-bold" x-text="v.familia_nombre"></div>
                                        <div class="small text-muted" x-text="'ID: ' + (v.familia_id || '-')"></div>
                                    </td>
                                    <td class="fw-bold" x-text="'$' + formatMoney(v.total)"></td>
                                    <td :class="{'text-danger': (v.saldo_historico||0)>0, 'text-success': (v.saldo_historico||0)<0}">
                                        <span x-text="'$' + formatMoney(v.saldo_historico)"></span>
                                    </td>
                                    <td>
                                        <span class="badge" :class="v.status === 'reembolsado' ? 'bg-danger' : (v.metodo_pago === 'Efectivo' ? 'bg-success' : 'bg-primary')" x-text="v.status === 'reembolsado' ? 'Anulado' : v.metodo_pago"></span>
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-secondary me-1" @click="reenviarBoleta(v)" title="Reenviar correo"><i class="bi bi-envelope"></i></button>
                                        <button class="btn btn-sm btn-outline-danger" @click="reembolsarVenta(v)" :disabled="currentUser.role !== 'admin' || v.status === 'reembolsado'" title="Anular"><i class="bi bi-x-circle"></i></button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <div x-show="view === 'stats'">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3 bg-white p-3 rounded shadow-sm">
                    <div><h3 class="m-0 fw-bold text-primary"><i class="bi bi-graph-up-arrow"></i> Dashboard</h3><small class="text-muted">Estad√≠sticas completas</small></div>
                    <div class="row g-2 align-items-end">
                        <div class="col-6 col-md-auto">
                            <label class="small fw-bold">Desde</label>
                            <input type="date" class="form-control" x-model="statsFilters.startDate">
                        </div>
                        
                        <div class="col-6 col-md-auto">
                            <label class="small fw-bold">Hasta</label>
                            <input type="date" class="form-control" x-model="statsFilters.endDate">
                        </div>
                        
                        <div class="col-12 col-md-auto d-flex gap-2">
                            <button class="btn btn-primary" @click="loadStatsView()" title="Refrescar">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            
                            <button class="btn btn-danger flex-fill" @click="downloadDeudas()" title="Descargar Deudores (.csv)">
                                <i class="bi bi-file-earmark-person"></i> <span class="d-md-none d-lg-inline">Deudas</span>
                            </button>
                            
                            <button class="btn btn-success flex-fill" @click="downloadExcel()" title="Descargar Historial (.csv)">
                                <i class="bi bi-file-earmark-spreadsheet"></i> <span class="d-md-none d-lg-inline">Todo</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-2">
                        <div class="card p-2 border-0 shadow-sm text-center h-100">
                            <small class="text-dark fw-bold">Ingresos (Efectivo + Cuenta familiar)</small>
                            <h4 class="my-1 text-success fw-bold" x-text="'$' + formatMoney(stats.ingresosTotales)"></h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card p-2 border-0 shadow-sm text-center h-100">
                            <small class="text-dark fw-bold">Solo Efectivo (Caja)</small>
                            <h4 class="my-1 text-success fw-bold" x-text="'$' + formatMoney(stats.efectivoTotal || 0)"></h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card p-2 border-0 shadow-sm text-center h-100">
                            <small class="text-dark fw-bold">Deuda total cuenta familiar</small>
                            <h4 class="my-1 text-danger fw-bold" x-text="'$' + formatMoney(stats.deudaTotal)"></h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card p-2 border-0 shadow-sm text-center h-100">
                            <small class="text-dark fw-bold">Cantidad de ventas</small>
                            <h4 class="my-1" x-text="stats.totalVentas || 0"></h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card p-2 border-0 shadow-sm text-center h-100">
                            <small class="text-dark fw-bold">Items vendidos</small>
                            <h4 class="my-1 text-warning" x-text="stats.itemsVendidos || 0"></h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card p-2 border-0 shadow-sm text-center h-100 bg-warning-subtle">
                            <small class="text-dark fw-bold">D√≠a con mayores ingresos </small>
                            <div class="lh-1 mt-1"><small x-text="bestDayMoney.date"></small>
                                <div class="fw-bold" x-text="'$' + formatMoney(bestDayMoney.total)"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card p-2 border-0 shadow-sm text-center h-100 bg-info-subtle">
                            <small class="text-dark fw-bold">D√≠a con mayores ventas</small>
                            <div class="lh-1 mt-1">
                                <small x-text="bestDayTx.date"></small>
                                <div class="fw-bold" x-text="(bestDayTx.count || 0) + ' ventas'"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3">

                    <div class="col-12">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="m-0 fw-bold">üèÜ Ranking Detallado de Productos</h6>
                                
                                <div class="d-flex align-items-center gap-2">
                                    <small class="text-muted d-none d-md-inline">Ordenar por:</small>
                                    <select class="form-select form-select-sm w-auto" x-model="chartConfig.topProdMetric" @change="renderCharts()">
                                        <option value="cantidad">Cantidad Vendida</option>
                                        <option value="total">Dinero Generado</option>
                                    </select>
                                </div>
                            </div>

                            <div class="card-body p-0 table-responsive">
                                <table class="table table-striped table-hover mb-0 align-middle">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 50px;" class="text-center">#</th>
                                            <th>Producto</th>
                                            <th class="text-center">Cant.</th>
                                            <th class="text-end pe-3">Total ($)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableTopProdBody">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between">
                                <h6 class="m-0 fw-bold">üìà Ventas por d√≠as</h6>
                                <select class="form-select form-select-sm w-auto" x-model="chartConfig.evolutionMetric" @change="renderCharts()"><option value="total">Dinero ($)</option><option value="tx">Transacciones (#)</option></select>
                            </div>
                            <div class="card-body"><canvas id="chartEvolution" style="max-height: 300px;"></canvas></div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white"><h6 class="m-0 fw-bold">üí≥ M√©todos de Pago</h6></div>
                            <div class="card-body d-flex align-items-center justify-content-center"><div style="width: 200px;"><canvas id="chartMethods"></canvas></div></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white"><h6 class="m-0 fw-bold">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Top 5 Familias con m√°s compras</h6></div>
                            <div class="card-body"><canvas id="chartFamilies"></canvas></div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white"><h6 class="m-0 fw-bold">üë§ Vendedores</h6></div>
                            <div class="card-body d-flex justify-content-center"><canvas id="chartSeller"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="view === 'config'">
                <h3>Configuraci√≥n</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card p-4 shadow-sm border-0 mb-3">
                            <h5>üé® Personalizaci√≥n Visual</h5>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Logo App</label>
                                <div class="input-group">
                                    <input type="file" class="form-control" @change="uploadConfig('app_logo', $event)">
                                    <button class="btn btn-outline-danger" type="button" 
                                            @click="deleteConfig('app_logo')" 
                                            x-show="config.app_logo" 
                                            title="Quitar Logo">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <small class="text-muted" x-text="config.app_logo ? '‚úÖ Logo personalizado activo' : '‚ö™ Sin logo (Por defecto)'"></small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">Favicon</label>
                                <div class="input-group">
                                    <input type="file" class="form-control" @change="uploadConfig('app_favicon', $event)">
                                    <button class="btn btn-outline-danger" type="button" 
                                            @click="deleteConfig('app_favicon')" 
                                            x-show="config.app_favicon" 
                                            title="Quitar Favicon">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <small class="text-muted" x-text="config.app_favicon ? '‚úÖ Favicon activo' : '‚ö™ Sin favicon'"></small>
                            </div>
                        </div>

                        <div class="card p-4 shadow-sm border-0 mb-3">
                            <h5>üìß Preferencias de Correo</h5>
                            <div class="form-check form-switch mt-3">
                                <input class="form-check-input" type="checkbox" id="checkDeuda" 
                                    style="cursor: pointer; width: 3em; height: 1.5em;"
                                    :checked="config.mostrar_deuda_email === 'true'"
                                    @change="toggleConfigDeuda($event)">
                                <label class="form-check-label ms-2 mt-1" for="checkDeuda" style="cursor: pointer;">
                                    <strong>Mostrar Deuda Total</strong>
                                    <small class="d-block text-muted">
                                        Si se desactiva, el correo solo mostrar√° el monto de la compra actual, ocultando el saldo hist√≥rico acumulado.
                                    </small>
                                </label>
                            </div>
                        </div>

                                    <div class="card p-4 shadow-sm border-0 mb-3">
                            <h5>üì® Copias de Respaldo (BCC)</h5>
                            <p class="small text-muted mb-2">Ingresa los correos que recibir√°n una copia oculta de cada venta.</p>
                            
                            <div class="mb-2">
                                <label class="form-label small fw-bold">Lista de Correos</label>
                                <textarea class="form-control" rows="2" 
                                        placeholder="jefe@empresa.com, contabilidad@empresa.com"
                                        x-model="config.email_copias"></textarea>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Separa con comas (,)</small>
                                <button class="btn btn-primary btn-sm" @click="saveConfig('email_copias', config.email_copias); alert('‚úÖ Correos de respaldo guardados.')">
                                    Guardar Lista
                                </button>
                            </div>
                        </div>

                    </div>

                    <div class="col-md-6">
                        <div class="card p-4 shadow-sm border-0 mb-3">
                            <h5>Organizar Men√∫</h5>
                            <ul class="list-group">
                                <template x-for="(id, index) in menuOrder" :key="id">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="bi me-2" :class="menuItems[id].icon"></i> <span x-text="menuItems[id].label"></span></span>
                                        <div>
                                            <button class="btn btn-sm btn-light" @click="moveMenu(index, -1)" :disabled="index===0">‚¨ÜÔ∏è</button>
                                            <button class="btn btn-sm btn-light" @click="moveMenu(index, 1)" :disabled="index===menuOrder.length-1">‚¨áÔ∏è</button>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </div>
                        <div class="card p-4 shadow-sm border-danger">
                            <h5 class="text-danger">Zona de Peligro</h5>
                            <div class="mb-4 pb-4 border-bottom border-danger-subtle">
                                <h6 class="fw-bold text-warning-emphasis">üöÄ Preparar para Producci√≥n</h6>
                                <p class="small text-muted mb-2">
                                    Esta opci√≥n borra <strong>Ventas, Familias y Bingos</strong>. 
                                    <br>
                                    <span class="text-success fw-bold">‚úÖ Tus Productos y Usuarios NO se borrar√°n.</span>
                                </p>
                                <button class="btn btn-warning w-100 fw-bold" @click="resetProduccion()">
                                    üßπ LIMPIAR DATOS DE PRUEBA
                                </button>
                            </div>
                            <div>
                                <h6 class="fw-bold text-danger">‚ò†Ô∏è Factory Reset</h6>
                                <p class="small text-muted mb-2">Borra ABSOLUTAMENTE TODO (Incluyendo productos y usuarios).</p>
                                <button class="btn btn-outline-danger w-100 btn-sm" @click="resetDatabase()">
                                    Borrar Base de Datos Completa
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="view === 'usuarios'">
                <div class="d-flex justify-content-between align-items-center mb-3"><h3>Usuarios</h3><button class="btn btn-primary" @click="toggleFormUsuario()"><i class="bi" :class="showFormUser ? 'bi-x-lg' : 'bi-plus-lg'"></i> <span x-text="showFormUser ? 'Cerrar' : 'Nuevo'"></span></button></div>
                <div x-show="showFormUser" class="card p-4 mb-4 border-0 shadow-sm bg-light" x-transition><div class="row g-3"><div class="col-md-4"><label>Usuario</label><input type="text" class="form-control" x-model="formUser.username"></div><div class="col-md-4"><label>Email</label><input type="email" class="form-control" x-model="formUser.email"></div><div class="col-md-4"><label>Nombre</label><input type="text" class="form-control" x-model="formUser.nombre"></div><div class="col-md-4"><label>Clave</label><input type="password" class="form-control" x-model="formUser.password"></div><div class="col-md-4"><label>Rol</label><select class="form-select" x-model="formUser.role"><option value="vendedor">Vendedor</option><option value="admin">Admin</option></select></div><div class="col-12 text-end"><button class="btn btn-success" @click="guardarUsuario()">Guardar</button></div></div></div>
                <div class="table-responsive bg-white rounded shadow-sm"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>User</th><th>Nombre</th><th>Email</th><th>Rol</th><th class="text-end">Acciones</th></tr></thead><tbody><template x-for="u in usuarios" :key="u.id"><tr><td x-text="u.username"></td><td x-text="u.nombre"></td><td x-text="u.email"></td><td><span class="badge" :class="u.role==='admin'?'bg-danger':'bg-success'" x-text="u.role"></span></td><td class="text-end"><button class="btn btn-sm btn-outline-primary" @click="prepararEdicionUsuario(u)" :disabled="u.username==='admin'&&currentUser.nombre!=='admin'">‚úèÔ∏è</button> <button class="btn btn-sm btn-outline-danger" @click="eliminar('usuarios', u.id)" :disabled="u.username==='admin'">X</button></td></tr></template></tbody></table></div>
            </div>
            <div x-show="view === 'familias'">
                <div class="d-flex justify-content-between align-items-center mb-3"><h3>Familias</h3><button class="btn btn-primary" @click="toggleFormFamilia()"><i class="bi" :class="showFormFamilia ? 'bi-x-lg' : 'bi-plus-lg'"></i> <span x-text="showFormFamilia ? 'Cerrar' : 'Nueva'"></span></button></div>
                <div x-show="showFormFamilia" class="card p-4 mb-4 border-0 shadow-sm bg-light" x-transition><div class="row g-3"><div class="col-md-4"><input type="text" class="form-control" placeholder="Nombre *" x-model="formFamilia.nombre"></div><div class="col-md-4"><input type="email" class="form-control" placeholder="Email *" x-model="formFamilia.email"></div><div class="col-md-4"><input type="text" class="form-control" placeholder="Tel√©fono *" x-model="formFamilia.telefono"></div><div class="col-md-4" x-show="formFamilia.id && currentUser.role==='admin'"><input type="number" class="form-control" placeholder="Deuda" x-model="formFamilia.deuda"></div><div class="col-12 text-end"><button class="btn btn-success" @click="guardarFamilia()">Guardar</button></div></div></div>
                <div class="table-responsive bg-white rounded shadow-sm">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Familia</th>
                                <th>Contacto</th>
                                <th>Deuda</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="f in familias" :key="f.id">
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary" x-text="f.id"></span>
                                    </td>
                                    <td x-text="f.nombre"></td>
                                    <td>
                                        <div x-text="f.email" class="small text-muted"></div>
                                        <div x-text="f.telefono" class="small text-primary"></div>
                                    </td>
                                    <td class="fw-bold" :class="{'text-danger': f.deuda > 0, 'text-success': f.deuda < 0}" x-text="'$' + formatMoney(f.deuda)"></td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary" @click="prepararEdicionFamilia(f)">‚úèÔ∏è</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="eliminar('familias', f.id)"x-show="currentUser.role === 'admin'">X</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
            <div x-show="view === 'productos'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="m-0">üì¶ Productos</h3>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-warning" @click="abrirReordenar()">
                            <i class="bi bi-arrow-down-up"></i> <span class="d-none d-md-inline">Reordenar</span>
                        </button>
                        
                        <button class="btn btn-primary" @click="toggleFormProducto()">
                            <i class="bi" :class="showFormProd ? 'bi-x-lg' : 'bi-plus-lg'"></i>
                            <span x-text="showFormProd ? 'Cerrar' : 'Nuevo'"></span>
                        </button>
                    </div>
                </div>
                
                <div x-show="showFormProd" class="card p-4 mb-4 border-0 shadow-sm bg-light" x-transition>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Nombre" x-model="formProd.nombre">
                        </div>
                        
                        <div class="col-md-4 position-relative" @click.outside="catListOpen = false">
                            <div class="tag-container" @click="$refs.catInput.focus(); catListOpen = true" style="cursor: text; background: white;">
                                <template x-for="(cat, i) in formProd.categorias">
                                    <span class="tag-badge">
                                        <span x-text="cat"></span>
                                        <span class="tag-remove" @click.stop="removerCategoria(i)">&times;</span>
                                    </span>
                                </template>
                                <input x-ref="catInput" 
                                    type="text" 
                                    class="tag-input" 
                                    placeholder="Categor√≠a (+Enter)" 
                                    x-model="catInput" 
                                    @focus="catListOpen = true"
                                    @input="catListOpen = true"
                                    @keydown.enter.prevent="agregarCategoria(catInput)" 
                                    @keydown.backspace="if(!catInput) removerCategoria(formProd.categorias.length-1)">
                            </div>

                            <ul class="suggestions-list" x-show="catListOpen" style="display:none;">
                                <li class="suggestion-item text-primary fw-bold" 
                                    x-show="catInput && !uniqueCategories.map(c=>c.toLowerCase()).includes(catInput.toLowerCase())"
                                    @mousedown.prevent="agregarCategoria(catInput)">
                                    <i class="bi bi-plus-circle"></i> Crear "<span x-text="catInput"></span>"
                                </li>
                                <template x-for="s in uniqueCategories.filter(c => !catInput || c.toLowerCase().includes(catInput.toLowerCase()))">
                                    <li class="suggestion-item" 
                                        x-show="!formProd.categorias || !formProd.categorias.includes(s)"
                                        @mousedown.prevent="agregarCategoria(s)">
                                        <span x-text="s"></span>
                                    </li>
                                </template>
                                <li class="p-2 text-muted small" x-show="uniqueCategories.length === 0 && !catInput">
                                    Escribe para crear una nueva
                                </li>
                            </ul>
                        </div>
                        
                        <div class="col-md-4 d-flex align-items-center gap-2">
                            <img x-show="formProd.foto" :src="formProd.foto" style="height:38px;">
                            <input type="file" id="fileInput" class="form-control" @change="handleFileUpload($event)">
                        </div>
                        
                        <div class="col-6 col-md-3">
                            <input type="number" class="form-control" placeholder="Precio" x-model="formProd.precio">
                        </div>
                        <div class="col-6 col-md-3">
                            <input type="number" class="form-control" placeholder="Stock" x-model="formProd.stock">
                        </div>
                        
                        <div class="col-12 mt-3 text-end">
                            <button class="btn btn-secondary" @click="toggleFormProducto()">Cancelar</button> 
                            <button class="btn btn-success" @click="guardarProducto()">Guardar</button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive bg-white rounded shadow-sm">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="60">Foto</th>
                                <th>Nombre</th>
                                <th>Categor√≠as</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="p in productos" :key="p.id">
                                <tr :class="{'table-secondary text-muted':!p.activo}">
                                    <td><img x-show="p.foto" :src="p.foto" style="width:40px;height:40px;object-fit:contain;"></td>
                                    <td x-text="p.nombre"></td>
                                    <td>
                                        <template x-for="c in (p.categoria||'').split(',').filter(Boolean)">
                                            <span class="badge bg-light text-dark border me-1" x-text="c"></span>
                                        </template>
                                    </td>
                                    <td x-text="'$' + formatMoney(p.precio)"></td>
                                    <td x-text="p.stock"></td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" :checked="p.activo" @change="cambiarEstadoProducto(p)">
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary" @click="prepararEdicion(p)">‚úèÔ∏è</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="eliminar('productos', p.id)">X</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalReorder" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reordenar Productos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Usa las flechas para mover la prioridad. Arriba = Primero.</p>
                    <div class="list-group">
                        <template x-for="(p, index) in productosTemp" :key="p.id">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span x-text="p.nombre"></span>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" @click="moverProducto(index, -1)" :disabled="index === 0"><i class="bi bi-arrow-up"></i></button>
                                    <button class="btn btn-sm btn-outline-secondary" @click="moverProducto(index, 1)" :disabled="index === productosTemp.length - 1"><i class="bi bi-arrow-down"></i></button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @click="guardarOrden()">Guardar Orden</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalFamiliaPOS" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-person-plus-fill"></i> Nueva Familia</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Nombre Familia <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" x-model="formFamiliaPOS.nombre" placeholder="Ej: Familia Gonz√°lez" @keydown.enter="$refs.inputEmailPOS.focus()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Email (Para recibir boletas) <span class="text-danger">*</span></label>
                        <input x-ref="inputEmailPOS" type="email" class="form-control" x-model="formFamiliaPOS.email" placeholder="correo@ejemplo.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Tel√©fono <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" x-model="formFamiliaPOS.telefono" placeholder="+569...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success fw-bold" @click="guardarFamiliaDesdePOS()">
                        <i class="bi bi-check-lg"></i> Guardar y Seleccionar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalBingoManual" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square"></i> Ingresar N√∫meros de Cart√≥n</h5>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Ingresa el n√∫mero impreso en cada cart√≥n f√≠sico que est√°s entregando.</p>
                    
                    <template x-for="(item, indexItem) in bingoInputData" :key="indexItem">
                        <div class="mb-3 p-2 border rounded bg-light">
                            <strong class="d-block mb-2 text-primary" x-text="item.nombre"></strong>
                            
                            <div class="row g-2">
                                <template x-for="(val, indexQty) in item.inputs" :key="indexQty">
                                    <div class="col-6 col-md-4">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">#</span>
                                            <input type="number" class="form-control fw-bold text-center" 
                                                placeholder="1-1000"
                                                x-model="bingoInputData[indexItem].inputs[indexQty]"
                                                min="1" max="1000">
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="cancelarVentaBingo()">Cancelar Venta</button>
                    <button type="button" class="btn btn-primary fw-bold" @click="confirmarNumerosBingo()">
                        Confirmar y Vender <i class="bi bi-check-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
<script>
let charts = {};
const now = new Date();
const today = now.toISOString().split('T')[0];

const past = new Date();
past.setDate(past.getDate() - 30);
const thirtyDaysAgo = past.toISOString().split('T')[0];

function appData() {
    return {
        // --- VARIABLES DE ESTADO ---
        token: localStorage.getItem('pos_token') || null,
        currentUser: JSON.parse(localStorage.getItem('pos_user')) || {},
        sidebarCollapsed: false, mobileMenuOpen: false, mobileCartOpen: false, view: 'pos', 
        loginForm: { username: '', password: '' }, loginError: false, cargando: false,

        // --- VARIABLES NUEVAS PARA MODO OFFLINE ---
        online: navigator.onLine,
        ventasPendientes: JSON.parse(localStorage.getItem('pos_queue') || '[]'),
        sincronizando: false,
        
        // Datos
        productos: [], familias: [], historialVentas: [], usuarios: [], carrito: [], stats: {}, productosTemp: [],
        formFamiliaPOS: { nombre: '', email: '', telefono: '+569' },

        // --- FUNCIONES NUEVAS PARA FAMILIA POS ---

        abrirModalFamiliaPOS() {
            // 1. Prellenamos el nombre con lo que haya escrito el usuario en el buscador (si escribi√≥ algo)
            this.formFamiliaPOS = {
                nombre: this.searchFamInput || '', 
                email: '', 
                telefono: '+569'
            };
            // 2. Cerramos la lista desplegable del carrito
            this.showFamList = false;
            // 3. Abrimos el modal
            new bootstrap.Modal(document.getElementById('modalFamiliaPOS')).show();
        },

        async guardarFamiliaDesdePOS() {
            // --- VALIDACI√ìN ESTRICTA NUEVA ---
            if (!this.formFamiliaPOS.nombre || !this.formFamiliaPOS.nombre.trim()) return alert("‚ö†Ô∏è El Nombre es obligatorio");
            if (!this.formFamiliaPOS.email || !this.formFamiliaPOS.email.trim()) return alert("‚ö†Ô∏è El Email es obligatorio para enviar boletas");
            if (!this.formFamiliaPOS.telefono || !this.formFamiliaPOS.telefono.trim()) return alert("‚ö†Ô∏è El Tel√©fono es obligatorio");

            try {
                // 1. Guardar en servidor
                const r = await this.fetchAuth('/api/familias', {
                    method: 'POST',
                    body: JSON.stringify(this.formFamiliaPOS)
                });

                if (r.ok) {
                    // 2. Recargar lista de familias (para que aparezca la nueva)
                    await this.cargarDatos();

                    // 3. Buscar la familia reci√©n creada para seleccionarla autom√°ticamente
                    // Como el backend no devuelve el ID al crear, la buscamos por nombre
                    const nombreBuscado = this.formFamiliaPOS.nombre.trim().toLowerCase();
                    const nuevaFamilia = this.familias.find(f => f.nombre.toLowerCase() === nombreBuscado);

                    if (nuevaFamilia) {
                        this.seleccionarFamilia(nuevaFamilia); // ¬°Esto la pone en el carrito!
                    }

                    // 4. Cerrar Modal y limpiar
                    const modalEl = document.getElementById('modalFamiliaPOS');
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    modalInstance.hide();
                    
                    // Mensaje discreto (opcional)
                    // alert("Familia creada y seleccionada"); 

                } else {
                    const errorData = await r.json();
                    alert(errorData.error || "Error al crear familia");
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexi√≥n");
            }
        },

        // Carrito y Filtros
        ventaActual: { familiaId: '', metodo: 'Efectivo' },
        filters: { search: '', metodo: '', startDate: '', endDate: '', vendedor: '', sort: 'desc' },
        statsFilters: { startDate: thirtyDaysAgo, endDate: today }, 
        
        // VARIABLES NUEVAS PARA CATEGOR√çA (IMPORTANTE)
        catListOpen: false, 
        catInput: '', 

        // Configuraci√≥n
        config: { menu_order: '[]', app_logo: '', app_favicon: '' },
        menuOrder: ['pos', 'ventas', 'familias', 'productos', 'usuarios', 'stats', 'config'],
        menuItems: { pos: { label: 'Vender', icon: 'bi-cart4', adminOnly: false }, ventas: { label: 'Historial', icon: 'bi-receipt', adminOnly: false }, familias: { label: 'Familias', icon: 'bi-people', adminOnly: false }, productos: { label: 'Productos', icon: 'bi-box-seam', adminOnly: true }, usuarios: { label: 'Usuarios', icon: 'bi-person-lock', adminOnly: true }, stats: { label: 'Estad√≠sticas', icon: 'bi-graph-up', adminOnly: true }, config: { label: 'Configuraci√≥n', icon: 'bi-gear', adminOnly: true } },

        // UI Helpers
        searchFamInput: '', showFamList: false, showFormUser: false, formUser: {}, showFormFamilia: false, formFamilia: {}, showFormProd: false, formProd: {}, fotoFile: null, searchProd: '', 

        formatMoney(n) {
            return (n || 0).toLocaleString('es-CL');
        },

        // --- COMPUTADOS (GETTERS) ---
        get productosFiltrados() { if(!this.searchProd) return this.productos; const s=this.searchProd.toLowerCase(); return this.productos.filter(p=>p.nombre.toLowerCase().includes(s)||(p.categoria&&p.categoria.toLowerCase().includes(s))); },
        get familiasFiltradas() { if(!this.searchFamInput) return this.familias.slice(0, 10); const s=this.searchFamInput.toLowerCase(); return this.familias.filter(f=>f.nombre.toLowerCase().includes(s)||f.id.toString().includes(s)).slice(0, 10); },
        get uniqueVendedores() { return [...new Set(this.historialVentas.map(v => v.vendedor))]; },
        get ventasFiltradas() {
            let v = this.historialVentas;
            if(this.filters.startDate) v = v.filter(x => x.fecha >= this.filters.startDate);
            if(this.filters.endDate) v = v.filter(x => x.fecha.split('T')[0] <= this.filters.endDate);
            if(this.filters.search) { const s=this.filters.search.toLowerCase(); v=v.filter(x=>x.familia_nombre.toLowerCase().includes(s)||x.vendedor.toLowerCase().includes(s)||(x.familia_id&&x.familia_id.toString().includes(s))); }
            if(this.filters.metodo) { if(this.filters.metodo==='reembolsado')v=v.filter(x=>x.status==='reembolsado'); else v=v.filter(x=>x.metodo_pago===this.filters.metodo&&x.status!=='reembolsado'); }
            if(this.filters.vendedor) v=v.filter(x=>x.vendedor===this.filters.vendedor);
            return v.sort((a,b)=>this.filters.sort==='desc'?new Date(b.fecha)-new Date(a.fecha):new Date(a.fecha)-new Date(b.fecha));
        },
        get totalCarrito() { return this.carrito.reduce((s,i)=>s+(i.precio*i.cantidad),0); },
        get uniqueCategories() { 
            const t=new Set(); 
            this.productos.forEach(p=>{
                if(p.categoria) p.categoria.split(',').forEach(c=>{
                    if(c && c.trim()) t.add(c.trim());
                })
            }); 
            return Array.from(t).sort(); 
        },

        // --- INICIALIZACI√ìN ---
        async initApp() { 
            // 1. Limpieza de seguridad (Agrega esto al inicio)
            if (!Array.isArray(this.ventasPendientes)) {
                this.ventasPendientes = [];
                localStorage.setItem('pos_queue', '[]');
            }
            // 2. Listeners de conexi√≥n
            window.addEventListener('online', () => { this.online = true; this.intentarSincronizar(); });
            window.addEventListener('offline', () => { this.online = false; });
            
            // 3. Cargar datos b√°sicos
            if(this.token) { 
                await this.cargarDatos(); 
                await this.loadConfig(); 
                
                // 4. NUEVO: Si entramos y ya hay internet, intentamos subir pendientes autom√°ticamente
                if(this.online && this.ventasPendientes.length > 0) {
                    console.log("Internet detectado al inicio. Sincronizando...");
                    setTimeout(() => this.intentarSincronizar(), 1000); // Peque√±a espera para asegurar carga
                }
            } 
        },
        async intentarSincronizar() {
            if (this.ventasPendientes.length === 0 || this.sincronizando || !this.online) return;

            this.sincronizando = true;
            const pendientes = [...this.ventasPendientes]; 
            const fallidos = []; // Aqu√≠ guardaremos solo las que fallan por INTERNET

            for (const venta of pendientes) {
                try {
                    const r = await this.fetchAuth('/api/ventas', {
                        method: 'POST', 
                        body: JSON.stringify(venta)
                    });

                    if (!r.ok) {
                        // Si el servidor dice "Error: Cart√≥n Repetido", NO la volvemos a intentar
                        const err = await r.json();
                        console.error("Venta rechazada por el servidor:", err);
                        
                        // Opcional: Avisar al usuario que una venta antigua fall√≥
                        // alert(`Una venta guardada fall√≥: ${err.error}`);
                    }
                    // Si r.ok es true, no hacemos nada (significa que se subi√≥ bien)

                } catch (e) {
                    // Solo si es error de CONEXI√ìN (fetch fall√≥), la mantenemos para despu√©s
                    console.error("Error de conexi√≥n al subir:", e);
                    fallidos.push(venta);
                }
            }

            // Actualizamos la cola solo con las que fallaron por conexi√≥n
            this.ventasPendientes = fallidos;
            localStorage.setItem('pos_queue', JSON.stringify(this.ventasPendientes));
            this.sincronizando = false;
            
            if(this.ventasPendientes.length === 0) {
                this.cargarDatos();
            }
        },
        async loadConfig() { try { const r=await this.fetchAuth('/api/config'); const d=await r.json(); if(d.menu_order)this.menuOrder=JSON.parse(d.menu_order); this.config=d; this.updateFavicon(); } catch(e){} },
        async saveConfig(k, v) { if(k==='menu_order')v=JSON.stringify(v); await this.fetchAuth('/api/config',{method:'POST',body:JSON.stringify({key:k,value:v})}); },
        async uploadConfig(k, e) { const fd=new FormData(); fd.append('key',k); fd.append('file',e.target.files[0]); const r=await fetch('/api/config/upload',{method:'POST',headers:{'Authorization':this.token},body:fd}); if(r.ok){const d=await r.json();this.config[k]=d.url;if(k==='app_favicon')this.updateFavicon();} },
        async deleteConfig(key) {
            if(!confirm("¬øEst√°s seguro de quitar esta imagen y volver al estado original?")) return;
            
            try {
                // Enviamos valor vac√≠o '' al servidor para borrar
                await this.saveConfig(key, '');
                
                // Actualizamos visualmente al instante
                this.config[key] = '';
                
                // Si borramos el favicon, quitamos el icono de la pesta√±a navegador tambi√©n
                if (key === 'app_favicon') {
                    document.getElementById('app-favicon').href = '';
                }
                
                alert("Imagen eliminada correctamente.");
            } catch (e) {
                console.error(e);
                alert("Error al eliminar.");
            }
        },
        async toggleConfigDeuda(e) {
            const isChecked = e.target.checked;
            const action = isChecked ? "MOSTRAR" : "OCULTAR";

            // Ventana de confirmaci√≥n
            if (!confirm(`CONFIRMACI√ìN:\n¬øEst√°s seguro que deseas ${action} la deuda acumulada en los correos a clientes?`)) {
                // Si el usuario cancela, revertimos el interruptor visualmente
                e.target.checked = !isChecked;
                return;
            }

            // Guardamos 'true' o 'false' como string en la base de datos
            const val = isChecked ? 'true' : 'false';
            
            // Actualizamos localmente para que se refleje inmediato
            this.config.mostrar_deuda_email = val;
            
            // Guardamos en el servidor
            await this.saveConfig('mostrar_deuda_email', val);
        },
        updateFavicon() { if(this.config.app_favicon) document.getElementById('app-favicon').href=this.config.app_favicon; },
        moveMenu(i,d) { const n=[...this.menuOrder],t=n[i]; n[i]=n[i+d]; n[i+d]=t; this.menuOrder=n; this.saveConfig('menu_order',this.menuOrder); },
        async resetDatabase() { if(confirm("¬°PELIGRO!")) { await this.fetchAuth('/api/reset-database',{method:'POST'}); window.location.reload(); } },
        async resetProduccion() {
            if(!confirm("‚ö†Ô∏è ATENCI√ìN ‚ö†Ô∏è\n\nEst√°s a punto de borrar todas las VENTAS y FAMILIAS de prueba.\n\nLos Productos y Usuarios SE MANTENDR√ÅN intactos.\n\n¬øEst√°s seguro de que quieres limpiar el sistema para salir a producci√≥n?")) return;

            try {
                const r = await this.fetchAuth('/api/reset-produccion', {method:'POST'});
                if(r.ok) {
                    alert("‚úÖ ¬°Sistema listo! Se han borrado las ventas y familias de prueba.");
                    window.location.reload();
                } else {
                    throw new Error("Error en el servidor");
                }
            } catch (e) {
                alert("Hubo un problema al limpiar los datos.");
            }
        },
        navigate(id) { if(id==='ventas')this.cargarVentas(); if(id==='familias')this.cargarDatos(); if(id==='stats')this.loadStatsView(); if(id==='usuarios')this.cargarUsuarios(); this.view=id; this.mobileMenuOpen=false; },
        
        // --- ESTAD√çSTICAS ---
        chartConfig: { 
            evolutionMetric: 'total', // 'total' ($) o 'tx' (cantidad)
            topProdMetric: 'cantidad', // 'cantidad' o 'total'
        },
        bestDayMoney: { date: '-', total: 0 }, 
        bestDayTx: { date: '-', count: 0 },

        async loadStatsView() {
            const url = `/api/stats?start=${this.statsFilters.startDate}&end=${this.statsFilters.endDate}`;
            this.stats = await (await this.fetchAuth(url)).json();
            
            // Calculamos el total de Efectivo buscando dentro del gr√°fico de m√©todos de pago
            let cash = 0;
            if (this.stats.charts && this.stats.charts.salesByMethod) {
                // Buscamos el m√©todo que se llame 'Efectivo'
                const found = this.stats.charts.salesByMethod.find(x => x.metodo_pago === 'Efectivo');
                if (found) cash = found.total;
            }
            // Guardamos el valor para usarlo en el HTML
            this.stats.efectivoTotal = cash;

            // C√ÅLCULO DE D√çAS R√âCORD
            this.bestDayMoney = { date: '-', total: 0 };
            this.bestDayTx = { date: '-', count: 0 };

            if (this.stats.charts && this.stats.charts.salesByDate) {
                this.stats.charts.salesByDate.forEach(d => {
                    if (d.total > this.bestDayMoney.total) this.bestDayMoney = { date: d.dia, total: d.total };
                    if (d.tx > this.bestDayTx.count) this.bestDayTx = { date: d.dia, count: d.tx };
                });
            }

            this.$nextTick(() => this.renderCharts());
        },
        renderCharts() {
            // 1. INICIALIZAR
            if (!this.charts) this.charts = {};

            // 2. LIMPIEZA
            ['chartEvolution', 'chartMethods', 'chartMetodos', 'chartTopProd', 'chartFamilies', 'chartHours', 'chartCats', 'chartSeller'].forEach(id => {
                if (this.charts[id]) {
                    this.charts[id].destroy();
                    this.charts[id] = null;
                }
            });

            // 3. REGISTRAR PLUGIN
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
            }

            if (!this.stats || !this.stats.charts) return;
            const d = this.stats.charts;

            // --- CONFIGURACI√ìN A: TORTAS (Texto Blanco con Sombra) ---
            // Usamos sombra para que se lea incluso en colores claros como amarillo
            const pieDatalabels = {
                color: '#ffffff',
                font: { weight: 'bold', size: 12 },
                textShadowBlur: 4,
                textShadowColor: '#000000',
                formatter: (value, ctx) => {
                    let sum = 0;
                    ctx.chart.data.datasets[0].data.map(data => { sum += data; });
                    if(sum === 0) return "0%";
                    if ((value * 100 / sum) < 5) return null; // Ocultar si es < 5%
                    return (value * 100 / sum).toFixed(1) + "%";
                }
            };
            // Especial para "Ventas por D√≠as" para que se lea sobre la l√≠nea
            const lineDatalabels = {
                color: '#333333',
                align: 'top',      // Flotando arriba del punto
                anchor: 'end',
                offset: 4,
                backgroundColor: 'rgba(255, 255, 255, 0.8)', // Fondo blanco semitransparente
                borderRadius: 4,
                padding: 4,
                font: { weight: 'bold', size: 10 },
                formatter: (value) => {
                    // Si la m√©trica actual es dinero, agregamos el signo $
                    return this.chartConfig.evolutionMetric === 'total' ? '$' + value.toLocaleString('es-CL') : value;
                }
            };

            // --- CONFIGURACI√ìN B: BARRAS (Texto Negro AFUERA) ---
            // Esto soluciona tu problema: Texto negro sobre el fondo blanco
            const barDatalabels = {
                color: '#333333', // Gris muy oscuro / Negro
                anchor: 'end',    // Anclado al final de la barra
                align: 'end',     // Empujado HACIA AFUERA
                offset: 0,        // Pegado al borde
                font: { weight: 'bold', size: 11 },
                formatter: (value, ctx) => {
                    // Detectar si es dinero
                    const label = ctx.dataset.label || '';
                    if (label.includes('$') || label.includes('Gastado') || label.includes('Dinero')) {
                        return '$' + value.toLocaleString('es-CL');
                    }
                    return value;
                }
            };

            // --- HELPER ---
            const createChart = (idCanvas, config) => {
                const ctx = document.getElementById(idCanvas);
                if (ctx) this.charts[idCanvas] = new Chart(ctx, config);
            };

            // -------------------------------------------------------

            // 1. EVOLUCI√ìN (LINEA) - AHORA CON ETIQUETAS ACTIVAS
            createChart('chartEvolution', {
                type: 'line',
                data: {
                    labels: d.salesByDate.map(x => x.dia),
                    datasets: [{
                        label: this.chartConfig.evolutionMetric === 'total' ? 'Ventas ($)' : 'Transacciones (#)',
                        data: d.salesByDate.map(x => this.chartConfig.evolutionMetric === 'total' ? x.total : x.tx),
                        borderColor: '#0d6efd', 
                        backgroundColor: 'rgba(13, 110, 253, 0.1)', 
                        fill: true, 
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                }, 
                options: { 
                    maintainAspectRatio: false,
                    scales: { 
                        y: { ticks: { callback: (v) => this.chartConfig.evolutionMetric === 'total' ? '$' + v.toLocaleString('es-CL') : v } } 
                    },
                    plugins: { 
                        // AQU√ç EST√Å EL CAMBIO: Asignamos la config de l√≠nea
                        datalabels: lineDatalabels 
                    }
                }
            });

            // 2. M√âTODOS DE PAGO (TORTA)
            const idMetodos = document.getElementById('chartMethods') ? 'chartMethods' : 'chartMetodos';
            createChart(idMetodos, {
                type: 'pie',
                data: {
                    labels: d.salesByMethod.map(x => x.metodo_pago || x.metodo),
                    datasets: [{
                        data: d.salesByMethod.map(x => x.total),
                        backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6c757d']
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' }, datalabels: pieDatalabels }
                }
            });

            // 3. TOP PRODUCTOS (SOLO TABLA)
            let topData = [...d.topProducts]; // Copiamos el array para no romper nada
            const metric = this.chartConfig.topProdMetric; // 'cantidad' o 'total'
            
            // ORDENAMIENTO DIN√ÅMICO
            // Re-ordenamos la lista seg√∫n lo que el usuario seleccion√≥ en el dropdown
            topData.sort((a, b) => b[metric] - a[metric]);

            // LLENADO DE TABLA
            const tableBody = document.getElementById('tableTopProdBody');
            if (tableBody) {
                tableBody.innerHTML = topData.map((item, index) => `
                    <tr>
                        <td class="fw-bold text-muted text-center">${index + 1}</td>
                        <td>
                            <div class="fw-bold text-dark">${item.nombre}</div>
                        </td>
                        <td class="text-center">
                            <span class="badge ${metric === 'cantidad' ? 'bg-primary' : 'bg-secondary'} rounded-pill">
                                ${item.cantidad}
                            </span>
                        </td>
                        <td class="text-end fw-bold pe-3 ${item.total > 0 ? 'text-success' : 'text-muted'}">
                            $${(item.total || 0).toLocaleString('es-CL')}
                        </td>
                    </tr>
                `).join('');
            }
            
            // Eliminamos el gr√°fico antiguo de la memoria si exist√≠a
            if(this.charts['chartTopProd']) {
                this.charts['chartTopProd'].destroy();
                delete this.charts['chartTopProd'];
            }

            // 4. TOP FAMILIAS (BARRAS VERTICALES)
            const topFam = d.salesByFamily.slice(0, 5);
            createChart('chartFamilies', {
                type: 'bar',
                data: {
                    labels: topFam.map(x => x.nombre),
                    datasets: [{ label: 'Total Gastado ($)', data: topFam.map(x => x.total), backgroundColor: '#6f42c1' }]
                },
                options: { 
                    maintainAspectRatio: false, 
                    layout: { padding: { top: 20 } }, // Espacio arriba para el texto
                    scales: { y: { ticks: { callback: (v) => '$' + v.toLocaleString('es-CL') } } },
                    plugins: { datalabels: barDatalabels }
                }
            });
            // 7. VENDEDORES (DONA)
            createChart('chartSeller', {
                type: 'doughnut',
                data: {
                    labels: d.salesBySeller.map(x => x.vendedor),
                    datasets: [{ data: d.salesBySeller.map(x => x.total), backgroundColor: ['#0dcaf0', '#adb5bd', '#20c997'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, datalabels: pieDatalabels } }
            });
        },
        // 1. Funci√≥n Gen√©rica para descargar archivos CON TOKEN (Soluciona el error 401)
        async downloadAuthenticated(url, filename) {
            try {
                // Usamos fetchAuth para que env√≠e el token autom√°ticamente
                const response = await this.fetchAuth(url);
                
                if (response.ok) {
                    // Convertimos la respuesta en un "Blob" (archivo binario)
                    const blob = await response.blob();
                    const urlBlob = window.URL.createObjectURL(blob);
                    
                    // Creamos un link invisible y le damos click
                    const a = document.createElement('a');
                    a.href = urlBlob;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    
                    // Limpiamos memoria
                    window.URL.revokeObjectURL(urlBlob);
                } else {
                    alert("‚ùå Error descargando archivo: No autorizado o error de servidor.");
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexi√≥n al descargar.");
            }
        },

        // 2. Descargar Historial de Ventas
        downloadExcel() {
            const url = `/api/export-csv?start=${this.statsFilters.startDate}&end=${this.statsFilters.endDate}`;
            this.downloadAuthenticated(url, `Ventas_${this.statsFilters.startDate}_${this.statsFilters.endDate}.csv`);
        },

        // 3. Descargar Deudas (Nueva funci√≥n)
        downloadDeudas() {
            this.downloadAuthenticated('/api/export-deudas', 'Reporte_Deudores.csv');
        },

        // --- CARRITO ---
        agregarAlCarro(p) { let i=this.carrito.find(x=>x.id===p.id); if(i)i.cantidad++; else this.carrito.push({...p,cantidad:1}); },
        seleccionarFamilia(f) { this.ventaActual.familiaId=f.id; this.searchFamInput=f.nombre; this.showFamList=false; },
        validarFamilia() { if(this.ventaActual.familiaId){const f=this.familias.find(x=>x.id===this.ventaActual.familiaId);if(!f||f.nombre!==this.searchFamInput)this.ventaActual.familiaId='';} },
        vaciarCarro() { 
            if(confirm("¬øEst√°s seguro de vaciar el carrito?")) {
                this.carrito = [];
                this.ventaActual.familiaId = '';
                this.searchFamInput = '';
                this.mobileCartOpen = false; // <--- Cierra el modal al vaciar
            } 
        },
        // 1. MODIFICA TU FUNCI√ìN procesarVenta AS√ç:
        async procesarVenta() {
            // A. Validaciones b√°sicas
            if(!this.ventaActual.familiaId) return alert("‚ö†Ô∏è Por favor seleccione una Familia/Cliente.");
            
            // B. DETECCI√ìN DE BINGO (NUEVO)
            // Buscamos si hay productos que contengan "bingo" o "carton" en el nombre
            const itemsBingo = this.carrito.filter(p => 
                p.nombre.toLowerCase().includes('bingo') || 
                p.nombre.toLowerCase().includes('carton')
            );

            if (itemsBingo.length > 0) {
                // SI HAY BINGOS: Preparamos los datos para el Modal
                this.bingoInputData = itemsBingo.map(p => ({
                    id: p.id,
                    nombre: p.nombre,
                    // Creamos espacios vac√≠os seg√∫n la cantidad vendida para los inputs
                    inputs: new Array(p.cantidad).fill('') 
                }));

                // Abrimos el modal y DETENEMOS la venta aqu√≠ hasta que confirmen
                new bootstrap.Modal(document.getElementById('modalBingoManual')).show();
                return; 
            }

            // SI NO HAY BINGOS: Flujo normal (Confirmar y Vender)
            if(!confirm("¬øConfirmar venta?")) return;
            
            // Llamamos a la funci√≥n que realmente guarda los datos
            this.ejecutarVentaReal();
        },

        // 2. AGREGA ESTAS FUNCIONES NUEVAS JUSTO DEBAJO:

        cancelarVentaBingo() {
            bootstrap.Modal.getInstance(document.getElementById('modalBingoManual')).hide();
            this.bingoInputData = [];
        },

        confirmarNumerosBingo() {
            // Validamos que no dejen n√∫meros vac√≠os
            for (let item of this.bingoInputData) {
                if (item.inputs.some(val => val === '' || val === null)) {
                    return alert(`‚ö†Ô∏è Faltan n√∫meros para: ${item.nombre}`);
                }
            }

            // Guardamos los n√∫meros ingresados dentro del producto en el carrito
            this.bingoInputData.forEach(bData => {
                const productoEnCarro = this.carrito.find(p => p.id === bData.id);
                if (productoEnCarro) {
                    productoEnCarro.numeros_manuales = bData.inputs; 
                }
            });

            // Cerramos el modal y procedemos a la venta real
            bootstrap.Modal.getInstance(document.getElementById('modalBingoManual')).hide();
            this.ejecutarVentaReal();
        },

        async ejecutarVentaReal() {
            const f = this.familias.find(x => x.id == this.ventaActual.familiaId);
            
            const datosVenta = {
                vendedor: this.currentUser.nombre,
                familia: f,
                total: this.totalCarrito,
                metodo: this.ventaActual.metodo,
                carrito: this.carrito, 
                fechaLocal: new Date().toISOString()
            };

            // --- NUEVA L√ìGICA ROBUSTA ---
            if (navigator.onLine) {
                try {
                    const r = await this.fetchAuth('/api/ventas', {
                        method: 'POST', 
                        body: JSON.stringify(datosVenta)
                    });

                    if (r.ok) {
                        // CASO 1: √âXITO TOTAL
                        this.intentarSincronizar(); 
                        // Limpieza UI
                        this.carrito = [];
                        this.ventaActual.familiaId = '';
                        this.searchFamInput = '';
                        this.mobileCartOpen = false;
                        this.cargarDatos();
                        return; // Salimos felices

                    } else {
                        // CASO 2: ERROR DE VALIDACI√ìN (Ej: Cart√≥n Repetido)
                        const errorData = await r.json();
                        // Mostramos el error real que viene del servidor
                        alert(errorData.error || "Error en el servidor");
                        return; // ‚õî DETENEMOS TODO. No guardamos en offline porque la venta est√° mala.
                    }

                } catch (e) {
                    // CASO 3: ERROR DE RED (Solo entramos aqu√≠ si falla el fetch por internet)
                    console.log("Fallo de red real:", e);
                    // Solo en este caso dejamos pasar al c√≥digo de abajo (Guardar Offline)
                }
            }

            // CASO 4: MODO OFFLINE (Sin internet o fallo de red)
            this.ventasPendientes.push(datosVenta);
            localStorage.setItem('pos_queue', JSON.stringify(this.ventasPendientes));
            alert("‚ö†Ô∏è Sin conexi√≥n. Venta guardada en el dispositivo.");

            // Limpieza UI Offline
            this.carrito = [];
            this.ventaActual.familiaId = '';
            this.searchFamInput = '';
            this.mobileCartOpen = false;
        },
        async reembolsarVenta(v){if(confirm("¬øAnular?")){await this.fetchAuth(`/api/ventas/${v.id}/refund`,{method:'POST'});this.cargarVentas();}},
        async reenviarBoleta(v){if(confirm("¬øReenviar?")){await this.fetchAuth(`/api/ventas/${v.id}/resend`,{method:'POST'});alert("Enviado");}},

        // --- FORMULARIOS ---
        toggleFormUsuario(){this.showFormUser=!this.showFormUser;if(!this.showFormUser)this.formUser={role:'vendedor'};},
        prepararEdicionUsuario(u){this.formUser={...u,password:''};this.showFormUser=true;},
        ttoggleFormFamilia() {
            this.showFormFamilia = !this.showFormFamilia;
            if (!this.showFormFamilia) {
                // Al cerrar/limpiar, dejamos el +569 listo
                this.formFamilia = { deuda: 0, telefono: '+569' }; 
            }
        },
        prepararEdicionFamilia(f){this.formFamilia={...f};this.showFormFamilia=true;},

        // --- [AQU√ç EST√Å LA MAGIA QUE ARREGLA LAS CATEGOR√çAS] ---
        agregarCategoria(c){
            if(!c) return;
            const val = c.trim();
            if(!val) return;

            // ESTO ARREGLA EL BOT√ìN GUARDAR: Inicializa el array si es null
            if (!this.formProd.categorias) {
                this.formProd.categorias = [];
            }

            // Evita duplicados y agrega
            if(!this.formProd.categorias.includes(val)) {
                this.formProd.categorias.push(val);
                console.log("Categor√≠a agregada:", val);
            }

            this.catInput = ''; 
            this.catListOpen = false;
        },
        removerCategoria(i){ 
            if(this.formProd.categorias) this.formProd.categorias.splice(i,1); 
        },

        toggleFormProducto(){this.showFormProd=!this.showFormProd;if(!this.showFormProd)this.resetFormProd();},
        resetFormProd(){
            // Inicializamos categor√≠as como array vac√≠o []
            this.formProd={categorias:[],activo:1,foto:''};
            this.fotoFile=null;
            this.catInput='';
            this.catListOpen=false;
            document.getElementById('fileInput')?document.getElementById('fileInput').value='':null;
        },
        prepararEdicion(p){
            const c=p.categoria?p.categoria.split(','):[];
            this.formProd={...p,categorias:c};
            this.showFormProd=true;
            window.scrollTo(0,0);
        },
        handleFileUpload(e){this.fotoFile=e.target.files[0]},
        
        async guardarUsuario(){let u='/api/usuarios',m='POST';if(this.formUser.id){u+=`/${this.formUser.id}`;m='PUT'} await this.fetchAuth(u,{method:m,body:JSON.stringify(this.formUser)}); this.toggleFormUsuario();this.cargarUsuarios();},
        async guardarFamilia() {
            // --- VALIDACI√ìN ESTRICTA NUEVA ---
            if (!this.formFamilia.nombre || !this.formFamilia.nombre.trim()) return alert("‚ö†Ô∏è El Nombre es obligatorio");
            if (!this.formFamilia.email || !this.formFamilia.email.trim()) return alert("‚ö†Ô∏è El Email es obligatorio");
            if (!this.formFamilia.telefono || !this.formFamilia.telefono.trim()) return alert("‚ö†Ô∏è El Tel√©fono es obligatorio");
            let u = '/api/familias', m = 'POST';
            if (this.formFamilia.id) {
                u += `/${this.formFamilia.id}`;
                m = 'PUT';
            }

            // Hacemos la petici√≥n
            const r = await this.fetchAuth(u, {
                method: m,
                body: JSON.stringify(this.formFamilia)
            });

            // VALIDAMOS LA RESPUESTA
            if (r.ok) {
                // ‚úÖ √âxito
                this.toggleFormFamilia();
                this.cargarDatos();
            } else {
                // ‚ùå Error (Nombre duplicado)
                const errorData = await r.json();
                alert(errorData.error || "Error al guardar familia");
            }
        },
        
        async guardarProducto(){
            const fd=new FormData(); 
            fd.append('nombre',this.formProd.nombre); 
            // Si categorias es undefined, enviamos string vac√≠o
            const catString = this.formProd.categorias ? this.formProd.categorias.join(',') : '';
            fd.append('categoria', catString); 
            fd.append('precio',this.formProd.precio); 
            fd.append('stock',this.formProd.stock||0); 
            fd.append('activo',this.formProd.activo?1:0); 
            if(this.fotoFile)fd.append('foto',this.fotoFile);

            let u='/api/productos',m='POST'; if(this.formProd.id){u+=`/${this.formProd.id}`;m='PUT'}
            
            await this.fetchAuth(u,{method:m,body:fd});
            
            // Recargar datos para ver cambios
            this.searchProd = '';
            this.productos = []; 
            await this.cargarDatos(); 
            this.toggleFormProducto();
        },

        async cambiarEstadoProducto(p){
            const fd=new FormData(); fd.append('nombre',p.nombre); fd.append('categoria',p.categoria); fd.append('precio',p.precio); fd.append('stock',p.stock); fd.append('activo',p.activo?0:1);
            await this.fetchAuth(`/api/productos/${p.id}`,{method:'PUT',body:fd}); this.cargarDatos();
        },
        async eliminar(t, id) {
            if (!confirm("¬øEst√°s seguro de eliminar este registro?")) return;

            // 1. Hacemos la petici√≥n al servidor
            const r = await this.fetchAuth(`/api/${t}/${id}`, { method: 'DELETE' });

            // 2. Verificamos si sali√≥ bien (Status 200) o mal (Status 400/500)
            if (r.ok) {
                // ‚úÖ √âXITO: Recargamos los datos
                if (t === 'usuarios') this.cargarUsuarios();
                else if (t === 'ventas') this.cargarVentas();
                else this.cargarDatos();
            } else {
                // ‚ùå ERROR: Leemos el mensaje del servidor y lo mostramos
                const errorData = await r.json();
                alert(errorData.error || "Ocurri√≥ un error al intentar eliminar.");
            }
        },

        // --- AUTH ---
        async login(){const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(this.loginForm)});if(r.ok){const d=await r.json();this.token=d.token;this.currentUser={role:d.role,nombre:d.nombre};localStorage.setItem('pos_token',this.token);localStorage.setItem('pos_user',JSON.stringify(this.currentUser));this.initApp();}else this.loginError=true;},
        logout(){fetch('/api/logout',{method:'POST',headers:{'Authorization':this.token}});this.token=null;localStorage.clear();},
        async fetchAuth(u,o={}){if(!o.headers)o.headers={};o.headers['Authorization']=this.token;if(!o.body||!(o.body instanceof FormData))o.headers['Content-Type']='application/json';return fetch(u,o);},
        async cargarDatos(){try{this.productos=await(await this.fetchAuth('/api/productos')).json();this.familias=await(await this.fetchAuth('/api/familias')).json();}catch(e){}},
        async cargarUsuarios(){this.usuarios=await(await this.fetchAuth('/api/usuarios')).json();}, async cargarVentas(){this.historialVentas=await(await this.fetchAuth('/api/ventas')).json();}, async cargarStats(){this.stats=await(await this.fetchAuth('/api/stats')).json();},
        abrirReordenar() {
            // Creamos una copia de los productos actuales para no afectar la vista principal hasta guardar
            this.productosTemp = JSON.parse(JSON.stringify(this.productos));
            new bootstrap.Modal(document.getElementById('modalReorder')).show();
        },

        moverProducto(index, direccion) {
            // L√≥gica simple para intercambiar elementos en el array
            const newIndex = index + direccion;
            if (newIndex >= 0 && newIndex < this.productosTemp.length) {
                const temp = this.productosTemp[newIndex];
                this.productosTemp[newIndex] = this.productosTemp[index];
                this.productosTemp[index] = temp;
            }
        },

        async guardarOrden() {
            // Preparamos el array para enviar al servidor: [{id: 1, orden: 0}, {id: 2, orden: 1}...]
            const itemsOrdenados = this.productosTemp.map((p, index) => ({
                id: p.id,
                orden: index
            }));

            try {
                const r = await this.fetchAuth('/api/productos/reorder', {
                    method: 'POST',
                    body: JSON.stringify({ items: itemsOrdenados })
                });

                if (r.ok) {
                    // Cerramos modal y recargamos productos
                    bootstrap.Modal.getInstance(document.getElementById('modalReorder')).hide();
                    this.cargarDatos(); // Esto traer√° la lista ordenada desde el servidor
                    alert("Orden actualizado correctamente");
                } else {
                    alert("Error al guardar el orden");
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexi√≥n");
            }
        }
    }
}
</script>
</body>
</html>